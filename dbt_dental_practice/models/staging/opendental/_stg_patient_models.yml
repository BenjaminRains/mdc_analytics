version: 2

models:
  - name: stg_patient
    description: "Standardized patient information from OpenDental"
    columns:
      - name: patient_id
        description: "Primary key for patient records"
        tests:
          - unique
          - not_null
      
      # Relationships
      - name: guarantor_id
        description: "Foreign key to guarantor patient"
      - name: primary_provider_id
        description: "Foreign key to primary provider"
        tests:
          - relationships:
              to: ref('stg_provider')
              field: provider_id
      - name: secondary_provider_id
        description: "Foreign key to secondary provider"
        tests:
          - relationships:
              to: ref('stg_provider')
              field: provider_id
      - name: clinic_id
        description: "Foreign key to clinic"
      - name: fee_schedule_id
        description: "Foreign key to fee schedule"
        tests:
          - relationships:
              to: ref('stg_feesched')
              field: fee_schedule_id
      
      # Demographics (minimal PHI)
      - name: middle_initial
        description: "Patient's middle initial"
      - name: preferred_name
        description: "Patient's preferred name"
      - name: gender
        description: "Patient's gender"
      - name: language
        description: "Patient's preferred language"
      
      # Status and Classification
      - name: patient_status
        description: "Current status of the patient"
      - name: position_code
        description: "Patient position classification"
      - name: student_status
        description: "Patient's student status if applicable"
      - name: urgency
        description: "Patient urgency classification"
      - name: premedication_required
        description: "Indicates if patient requires premedication"
      
      # Contact Preferences
      - name: preferred_confirmation_method
        description: "Patient's preferred method for appointment confirmations"
      - name: preferred_contact_method
        description: "Patient's preferred method for general contact"
      - name: preferred_recall_method
        description: "Patient's preferred method for recall notifications"
      - name: text_messaging_consent
        description: "Indicates if patient has consented to text messaging"
      - name: prefer_confidential_contact
        description: "Indicates if patient requires confidential contact"
      
      # Financial Information
      - name: estimated_balance
        description: "Estimated current balance"
      - name: total_balance
        description: "Total outstanding balance"
      - name: balance_0_30_days
        description: "Balance aged 0-30 days"
      - name: balance_31_60_days
        description: "Balance aged 31-60 days"
      - name: balance_61_90_days
        description: "Balance aged 61-90 days"
      - name: balance_over_90_days
        description: "Balance aged over 90 days"
      - name: insurance_estimate
        description: "Estimated insurance portion"
      - name: payment_plan_due
        description: "Amount due under payment plan"
      - name: has_insurance_flag
        description: "Indicates if patient has insurance"
      - name: billing_cycle_day
        description: "Day of month for billing cycle"
      
      # Dates
      - name: birth_date
        description: "Patient's date of birth"
      - name: age
        description: "Calculated age of patient"
      - name: first_visit_date
        description: "Date of patient's first visit"
      - name: deceased_datetime
        description: "Date and time of death if applicable"
      - name: admit_date
        description: "Date patient was admitted"
      
      # Scheduling Preferences
      - name: schedule_not_before_time
        description: "Earliest preferred appointment time"
      - name: schedule_not_after_time
        description: "Latest preferred appointment time"
      - name: preferred_day_of_week
        description: "Preferred day for appointments"
      - name: ask_to_arrive_early_minutes
        description: "Minutes patient should arrive before appointment"
      
      # Metadata
      - name: created_at
        description: "When the patient record was created"
        tests:
          - not_null
      - name: updated_at
        description: "When the patient record was last updated"
      - name: created_by_user_id
        description: "User who created the patient record"
      - name: planned_treatment_complete
        description: "Indicates if planned treatment is complete"

  - name: stg_patientlink
    description: "Links between related patient records"
    columns:
      - name: patient_link_id
        description: "Primary key for patient links"
        tests:
          - unique
          - not_null
      - name: from_patient_id
        description: "Foreign key to source patient"
        tests:
          - not_null
          - relationships:
              to: ref('stg_patient')
              field: patient_id
      - name: to_patient_id
        description: "Foreign key to target patient"
        tests:
          - not_null
          - relationships:
              to: ref('stg_patient')
              field: patient_id
      - name: link_type
        description: "Type of relationship between patients"
      - name: link_created_datetime
        description: "When the patient link was created"
        tests:
          - not_null

  - name: stg_patientnote
    description: "Patient preferences and clinical notes"
    columns:
      # Primary Key
      - name: patient_id
        description: "Primary key - foreign key to patient"
        tests:
          - unique
          - not_null
          - relationships:
              to: ref('stg_patient')
              field: patient_id

      # Emergency Contact (minimal PHI)
      - name: emergency_contact_name
        description: "Name of emergency contact"
      - name: emergency_contact_phone
        description: "Phone number for emergency contact"

      # Patient Preferences
      - name: consent_flag
        description: "Patient consent status"
      - name: pronoun_preference
        description: "Patient's preferred pronouns"

      # Orthodontic Information
      - name: ortho_months_treatment_override
        description: "Override for orthodontic treatment duration"
      - name: ortho_placement_date_override
        description: "Override for orthodontic placement date"
      - name: ortho_locked_by_user_id
        description: "User who locked orthodontic settings"
        tests:
          - relationships:
              to: ref('stg_userod')
              field: user_id

      # Metadata
      - name: created_at
        description: "When the note record was created"
        tests:
          - not_null
      - name: updated_at
        description: "When the note record was last updated"

  - name: stg_toothinitial
    description: "Initial tooth conditions and charting records"
    columns:
      - name: tooth_initial_id
        description: "Primary key for initial tooth conditions"
        tests:
          - unique
          - not_null
      - name: patient_id
        description: "Foreign key to patient"
        tests:
          - not_null
          - relationships:
              to: ref('stg_patient')
              field: patient_id
      - name: tooth_number
        description: "Tooth number being documented"
        tests:
          - not_null
      - name: initial_condition_type
        description: "Type of initial tooth condition"
      - name: movement_value
        description: "Tooth movement measurement"
      - name: drawing_segment
        description: "Segment information for tooth drawing"
      - name: drawing_color
        description: "Color used in tooth drawing"
      - name: drawing_text
        description: "Text annotations for tooth drawing"
      - name: created_at
        description: "When the record was created"
        tests:
          - not_null
      - name: updated_at
        description: "When the record was last updated"

  - name: stg_zipcode
    description: "Reference data for postal codes"
    columns:
      - name: zipcode_id
        description: "Primary key for zipcode records"
        tests:
          - unique
          - not_null
      - name: zipcode
        description: "Postal code digits"
        tests:
          - not_null
      - name: city_name
        description: "City name associated with zipcode"
      - name: state_code
        description: "State code associated with zipcode"
      - name: is_frequent_flag
        description: "Indicates if zipcode is frequently used"