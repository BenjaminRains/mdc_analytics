flowchart LR
    %% Patient and Procedure
    A[Patient] -->|Undergoes Procedure| B[ProcedureLog<br>ProcNum, ProcFee, ProcStatus]

    %% Fee Processing & Verification
    subgraph "Fee Processing & Verification"
        B -->|"Initial Clinic Fee Set"| C[Clinic Fee Source<br>Standard Tiers]
        C -->|"Verifies/Updates Fee"| B
        B -->|"Lookup Fee Schedule"| D[Fee Schedule Check]
        D -->|"No Schedule"| E[Fee Setting Decision]
        D -->|"Has Schedule"| F[Contracted Rates]
        F -->|"Updates Clinic Fee"| B
    end

    %% Insurance Processing
    subgraph "Insurance Processing"
        B -->|"Creates Claim"| I[Claim<br>ClaimNum, Status]
        I -->|"Batch Rules"| BA[Batch Analysis<br>Size, Timing, Value]
        BA -->|"Optimizes"| BS[Batch Submission<br>2-3 Claims, Similar Values]
        BS -->|"Generates ClaimProc"| J[ClaimProc<br>ProcNum, Status]
        J -->|"For Insurance"| K[Insurance Carrier/Plan]
        K -->|"Receives Estimation"| L[Insurance Estimation]
        L -->|"Documents Payment"| M[Insurance Payment]
    end

    %% Payment Allocation & Reconciliation
    subgraph "Payment Allocation & Reconciliation"
        M -->|"Insurance Payment"| Q[Payment Application]
        B -->|"Patient Payment"| Q
        Q -->|"Split Rules"| SP[Split Pattern Analysis<br>Normal vs Complex]
        SP -->|"Normal (99.3%)"| NS[Normal Splits<br>1-3 per payment]
        SP -->|"Complex (0.7%)"| CS[Complex Splits<br>Max 2 claims/proc]
        NS -->|"Validate"| R[Balance Calculation]
        CS -->|"Validate"| R
        R -->|"Split by Type"| AR[AR Distribution<br>Patient vs Insurance]
        R -->|"Date Validation"| T[Transaction Date Check]
        T -->|"Before as_of_date"| S[Aging Analysis]
        T -->|"After as_of_date"| U[Exclude from AR]
    end

    %% Collection Status Flow
    subgraph "Collection Status Flow"
        S -->|"Age Classification"| AG[Aging Buckets]
        AG -->|"Collection State"| CST[Collection Status]
        CST -->|"New"| SC[Scheduled]
        CST -->|"Active"| UF[Under Follow-up]
        CST -->|"Pending"| OS[Outstanding]
        CST -->|"Failed"| FE[Follow-up Exhausted]
        
        %% Collection Actions
        SC -->|"Start"| ACT[Collection Actions]
        UF -->|"Monitor"| ACT
        OS -->|"Chase"| ACT
        FE -->|"Escalate"| ACT
        
        ACT -->|"Success"| COL[Collected]
        ACT -->|"Failure"| ESC[Escalation Options]
    end

    %% Success Criteria
    subgraph "Success Criteria"
        COL -->|"Complete"| X[Journey Complete]
        ESC -->|"Write-off"| X
        ESC -->|"Legal"| Y[Legal Collection]
        ESC -->|"Agency"| Z[Collection Agency]
    end

    %% Styling
    style "Fee Processing & Verification" fill:#f9f,stroke:#333,stroke-width:2px
    style "Insurance Processing" fill:#bbf,stroke:#333,stroke-width:2px
    style "Payment Allocation & Reconciliation" fill:#ff9,stroke:#333,stroke-width:2px
    style "Collection Status Flow" fill:#fef,stroke:#333,stroke-width:2px
    style "Success Criteria" fill:#ffd,stroke:#333,stroke-width:2px

    